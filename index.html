<script type="module">
  // FIXED: Use Firebase v10 (stable, works with CDN modules)
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
  import { getFirestore, collection, query, onSnapshot, doc, updateDoc, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
  import Sortable from 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js';

  // Your Firebase config (this is correct!)
  const firebaseConfig = {
    apiKey: "AIzaSyAbKXYb0ImzYCoyzZG8pM70S2k3hilCppE",
    authDomain: "drone-team-rotation.firebaseapp.com",
    projectId: "drone-team-rotation",
    storageBucket: "drone-team-rotation.firebasestorage.app",
    messagingSenderId: "972886553431",
    appId: "1:972886553431:web:c7253c4c8862e921720412",
    measurementId: "G-VF7HF4EC4S"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app); // Now db is defined!

  // Display-only mode
  const isDisplayOnly = new URLSearchParams(window.location.search).get('display') === '1';
  document.body.classList.toggle('no-drag', isDisplayOnly);

  const lists = {
    waiting:    document.getElementById('waiting'),
    warehouseA: document.getElementById('warehouseA'),
    warehouseB: document.getElementById('warehouseB'),
    nextup:     document.getElementById('nextup')
  };

  const stationMap = {
    waiting:    null,
    warehouseA: 'warehouseA',
    warehouseB: 'warehouseB',
    nextup:     'nextup'
  };

  // Listen for real-time updates
  function listenToTeams() {
    const q = query(collection(db, 'teams'));
    onSnapshot(q, (snapshot) => {
      // Clear all lists
      Object.values(lists).forEach(list => list.innerHTML = '');

      snapshot.docs.forEach(docSnap => {
        const team = docSnap.data();
        const station = team.station || null;
        let target = lists.waiting;

        if (station === 'warehouseA') target = lists.warehouseA;
        else if (station === 'warehouseB') target = lists.warehouseB;
        else if (station === 'nextup') target = lists.nextup;

        const card = document.createElement('div');
        card.className = 'team-card';
        card.dataset.id = docSnap.id;
        card.draggable = !isDisplayOnly;
        card.textContent = team.teamName;
        target.appendChild(card);
      });

      initSortable(); // Re-init drag/drop
    }, (error) => {
      console.error("Firestore error:", error);
    });
  }

  // Initialize drag & drop
  function initSortable() {
    if (isDisplayOnly) return;

    Object.keys(lists).forEach(key => {
      // Destroy existing Sortable if exists
      if (lists[key].sortable) lists[key].sortable.destroy();

      lists[key].sortable = new Sortable(lists[key], {
        group: 'teams',
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: async (evt) => {
          const teamId = evt.item.dataset.id;
          const newStation = stationMap[evt.to.id];

          try {
            const ref = doc(db, 'teams', teamId);
            await updateDoc(ref, {
              station: newStation,
              updatedAt: serverTimestamp()
            });
          } catch (err) {
            console.error("Update failed:", err);
            alert("Failed to update team. Check console.");
          }
        }
      });
    });
  }

  // Start listening
  listenToTeams();

  // Add team button (control only)
  if (!isDisplayOnly) {
    const btn = document.createElement('button');
    btn.innerText = '+ Add Team';
    btn.className = 'btn btn-success';
    btn.style.position = 'fixed';
    btn.style.top = '10px';
    btn.style.right = '10px';
    btn.style.zIndex = '1000';
    btn.onclick = async () => {
      const name = prompt('Team name?');
      if (name?.trim()) {
        try {
          await addDoc(collection(db, 'teams'), {
            teamName: name.trim(),
            station: null,
            createdAt: serverTimestamp()
          });
        } catch (err) {
          console.error("Add failed:", err);
          alert("Failed to add team.");
        }
      }
    };
    document.body.appendChild(btn);
  }
</script>
